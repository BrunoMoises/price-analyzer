name: Deploy to Production

on:
  push:
    branches: 
      - "main"
      - "master"

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Execute remote commands via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          echo "üöÄ Iniciando Deploy Autom√°tico..."
          
          # 1. Navega para a pasta do projeto
          cd /var/www/price-analyzer
          
          # 2. Garante permiss√µes (opcional, mas bom pra evitar erro de git)
          # git config --global --add safe.directory /var/www/price-analyzer
          
          # 3. Baixa o c√≥digo novo
          git pull origin main
          
          # 4. Reconstr√≥i e sobe os containers
          # O flag --build for√ßa a recompila√ß√£o do Go e Next.js
          docker-compose -f docker-compose.prod.yml up -d --build
          
          # 5. Limpeza de imagens antigas (economiza espa√ßo em disco)
          docker image prune -f
          
          echo "‚úÖ Deploy Conclu√≠do com Sucesso!"