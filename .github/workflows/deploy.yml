name: Deploy to Production

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy Local
      run: |
        echo "üöÄ Runner local iniciado..."
        
        # 1. Define a pasta do projeto
        TARGET_DIR="/var/www/price-analyzer"
        
        # 2. Garante que a pasta existe (seguran√ßa)
        if [ ! -d "$TARGET_DIR" ]; then
          echo "‚ùå Pasta do projeto n√£o encontrada!"
          exit 1
        fi
        
        # 3. Navega at√© a pasta
        cd $TARGET_DIR
        
        # 4. Atualiza o c√≥digo
        # Precisamos configurar o git para aceitar o diret√≥rio se houver erro de 'safe directory'
        git config --global --add safe.directory $TARGET_DIR
        
        # Reseta qualquer mudan√ßa local para evitar conflito e puxa
        git reset --hard
        git pull origin main
        
        # 5. Sobe os containers
        echo "üê≥ Atualizando containers..."
        
        # Tenta derrubar tudo primeiro para evitar conflito de nomes
        # O '|| true' garante que o script n√£o pare se der erro aqui (ex: container n√£o existe)
        docker-compose -f docker-compose.prod.yml down --remove-orphans || true
        
        # Sobe limpo
        docker-compose -f docker-compose.prod.yml up -d --build
        
        # 6. Limpeza
        docker image prune -f
        
        echo "‚úÖ Deploy Conclu√≠do com Sucesso!"